from brython_robot4 import init, load_scene_from_url, get_url_parameter
from browser import aio

# ------------------------------------------------------------
# è¼”åŠ©å‡½å¼ (Helper Functions)
# ------------------------------------------------------------

async def turn_right(robot):
    """è®“æ©Ÿå™¨äººå³è½‰ä¸€æ¬¡ (ç›¸ç•¶æ–¼å·¦è½‰ä¸‰æ¬¡)"""
    for _ in range(3):
        await robot.turn_left()

async def ensure_direction(robot, target_direction):
    """å°‡æ©Ÿå™¨äººè½‰å‘æŒ‡å®šçš„æ–¹å‘ (0:æ±, 1:åŒ—, 2:è¥¿, 3:å—)"""
    while robot.direction() != target_direction:
        await robot.turn_left()

async def collect_if_carrots_present(robot, limit):
    """åœ¨ç•¶å‰æ ¼å­æ¡é›†æ‰€æœ‰èƒ¡è˜¿è””ï¼Œç›´åˆ°æ¸…ç©ºæˆ–é”åˆ°ä¸Šé™ã€‚"""
    collected = False
    while robot.background_is("pale_grass") and robot.carrots_collected < limit:
        await robot.pick_carrot()
        collected = True
    return collected

# ------------------------------------------------------------
# ä¸»è¦è¡Œç‚ºè…³æœ¬ (Core Robot Actions)
# ------------------------------------------------------------

async def robot_actions(robot):
    print("ğŸ¤– å•Ÿå‹•æ©Ÿå™¨äººï¼ŒåŸ·è¡Œæ°´å¹³ä¾†å›æ¡æ”¶æ¨¡å¼ (å„ªåŒ–ç‰ˆ)ã€‚")
    
    OBJECT_LIMIT = robot.config.max_carrots # æ‡‰ç‚º 36
    
    # 1. åˆå§‹å®šä½ï¼šç§»å‹•åˆ°æ¡æ”¶å€åŸŸçš„èµ·é»
    # å‡è¨­é€™æ˜¯å¾ (0, 0) ç§»åˆ° (2, 2) ä¸¦é¢å‘åŒ—æ–¹ (1) çš„éç¨‹
    
    # å˜—è©¦å‘å‰ç§»å‹• 2 æ­¥
    for _ in range(2):
        if robot.front_is_clear():
            await robot.move(1)
        else:
            print("ğŸš¨ å®šä½éšæ®µé‡åˆ°éšœç¤™ï¼Œç„¡æ³•ç§»å‹• 2 æ­¥ã€‚")
            return
            
    await robot.turn_left() # è½‰å‘è¥¿æ–¹ (2)
    
    # å˜—è©¦å‘å‰ç§»å‹• 2 æ­¥
    for _ in range(2):
        if robot.front_is_clear():
            await robot.move(1)
        else:
            print("ğŸš¨ å®šä½éšæ®µé‡åˆ°éšœç¤™ï¼Œç„¡æ³•ç§»å‹• 2 æ­¥ã€‚")
            return

    # ç¢ºä¿æ©Ÿå™¨äººé¢å‘æ±æ–¹ (East: 0) ä½œç‚ºèµ·é»
    await ensure_direction(robot, 0)
    
    # ------------------------------------------------------------
    # 2. æ¡æ”¶è¿´åœˆé‚è¼¯ï¼šä¾†å›æƒæ
    # ------------------------------------------------------------
    
    row_count = 0
    done = False
    
    # å¤–éƒ¨è¿´åœˆæ§åˆ¶ä¾†å›æƒæ
    while robot.carrots_collected < OBJECT_LIMIT and not done:
        
        # æ±ºå®šç•¶å‰è¡Œçš„æ¡é›†æ–¹å‘ (0:æ±, 2:è¥¿)
        direction = 0 if row_count % 2 == 0 else 2
        
        # ç¢ºä¿æœå‘æ­£ç¢ºçš„æ–¹å‘
        await ensure_direction(robot, direction)
        
        print(f"-> æ¡é›†ç¬¬ {row_count + 1} è¡Œ ({'æ±' if direction == 0 else 'è¥¿'})")

        # æ¡é›†ä¸€è¡Œ (æœ€å¤š 6 æ­¥)
        for step in range(6):
            
            # 1. æ¡é›†ç•¶å‰æ ¼å­
            await collect_if_carrots_present(robot, OBJECT_LIMIT)
                
            if robot.carrots_collected >= OBJECT_LIMIT:
                done = True
                break
                
            # 2. ç§»å‹•åˆ°ä¸‹ä¸€æ ¼ (å¦‚æœä¸æ˜¯æœ€å¾Œä¸€æ ¼)
            if step < 5: 
                if robot.front_is_clear():
                    await robot.move(1)
                else:
                    print("ğŸš¨ æ¡é›†ä¸­é‡åˆ°éšœç¤™ï¼Œæå‰åœæ­¢æ¡æ”¶ã€‚")
                    done = True
                    break
        
        if done: break

        # 3. æ›è¡Œæº–å‚™ï¼šè½‰å‘ä¸Šæ–¹ (North: 1)
        await ensure_direction(robot, 1) # è½‰å‘åŒ—æ–¹
            
        if robot.front_is_clear():
            await robot.move(1) # å‘ä¸Šæ›è¡Œ
            row_count += 1
        else:
            # å·²ç¶“åˆ°é”ä¸–ç•Œçš„é ‚éƒ¨æˆ–é‚Šç•Œ
            print("â¬†ï¸ ç„¡æ³•å‘ä¸Šæ›è¡Œï¼Œå·²åˆ°é”ä¸–ç•Œé‚Šç•Œã€‚æ¡é›†çµæŸã€‚")
            break
            
    # ------------------------------------------------------------
    # 3. ç¨‹å¼çµæŸ
    # ------------------------------------------------------------
    
    if robot.carrots_collected >= OBJECT_LIMIT:
        print(f"âœ… ä»»å‹™å®Œæˆï¼å·²æ¡é›† {robot.carrots_collected} å€‹èƒ¡è˜¿è””ã€‚")
    else:
        print(f"ğŸ ç¨‹å¼åŸ·è¡Œå®Œç•¢ã€‚ç¸½å…±æ¡é›†äº† {robot.carrots_collected} å€‹èƒ¡è˜¿è””ã€‚")

# ç¨‹å¼å•Ÿå‹•é»
async def main():
    world_url = get_url_parameter('world')
    if world_url:
        scene_data = await load_scene_from_url(world_url)
        # é€™è£¡è¨­å®šå®¹é‡ä¸Šé™ç‚º 36ï¼Œèˆ‡åŸç¨‹å¼ç¢¼çš„é™åˆ¶åŒ¹é…
        world, robot = init(scene_data, robot_config={"max_carrots": 36})
    else:
        # é è¨­å ´æ™¯ä¹Ÿè¨­å®šå®¹é‡ä¸Šé™
        world, robot = init(robot_config={"max_carrots": 36})

    if robot:
        await robot_actions(robot)

# å•Ÿå‹•ä¸»ç¨‹å¼
aio.run(main())
